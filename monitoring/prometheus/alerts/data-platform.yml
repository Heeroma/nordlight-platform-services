groups:
  - name: data_platform_alerts
    interval: 30s
    rules:
      # Storage Alerts
      - alert: ClickHouseDown
        expr: data_platform_clickhouse_connected == 0
        for: 2m
        labels:
          severity: critical
          component: storage
        annotations:
          summary: "ClickHouse connection lost"
          description: "ClickHouse has been disconnected for more than 2 minutes"

      - alert: RedisDown
        expr: data_platform_redis_connected == 0
        for: 2m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Redis connection lost"
          description: "Redis has been disconnected for more than 2 minutes"

      - alert: LowRedisCacheHitRate
        expr: data_platform_redis_hit_rate < 50
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Redis cache hit rate is low"
          description: "Cache hit rate is {{ $value }}%, below 50% threshold"

      # Data Quality Alerts
      - alert: LowDataQuality
        expr: data_platform_data_quality_score{layer="overall"} < 75
        for: 5m
        labels:
          severity: warning
          component: quality
        annotations:
          summary: "Overall data quality is low"
          description: "Data quality score is {{ $value }}%, below 75% threshold"

      - alert: CriticalDataQuality
        expr: data_platform_data_quality_score{layer="overall"} < 50
        for: 2m
        labels:
          severity: critical
          component: quality
        annotations:
          summary: "Critical data quality issue"
          description: "Data quality score is {{ $value }}%, below 50% threshold"

      - alert: StaleData
        expr: data_platform_data_freshness_score < 70
        for: 15m
        labels:
          severity: warning
          component: quality
        annotations:
          summary: "Data freshness is degraded"
          description: "Freshness score for {{ $labels.layer }} is {{ $value }}%"

      # ETL Alerts
      - alert: ETLJobFailed
        expr: increase(data_platform_etl_job_executions_total{status="failure"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: etl
        annotations:
          summary: "ETL job {{ $labels.job_name }} failed"
          description: "Job {{ $labels.job_name }} has failed {{ $value }} times in the last 5 minutes"

      - alert: ETLJobDurationHigh
        expr: histogram_quantile(0.95, sum(rate(data_platform_etl_job_duration_seconds_bucket[10m])) by (job_name, le)) > 600
        for: 5m
        labels:
          severity: warning
          component: etl
        annotations:
          summary: "ETL job {{ $labels.job_name }} running slow"
          description: "p95 duration is {{ $value }}s (threshold: 600s)"

      - alert: NoETLJobsRunning
        expr: data_platform_etl_jobs_scheduled > 0 and data_platform_etl_jobs_running == 0
        for: 30m
        labels:
          severity: warning
          component: etl
        annotations:
          summary: "No ETL jobs are currently running"
          description: "{{ $value }} jobs scheduled but none running for 30+ minutes"

      # API Performance Alerts
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, sum(rate(data_platform_api_request_duration_seconds_bucket[5m])) by (endpoint, le)) > 5
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API latency on {{ $labels.endpoint }}"
          description: "p95 latency is {{ $value }}s (threshold: 5s)"

      - alert: HighAPIErrorRate
        expr: |
          sum(rate(data_platform_api_requests_total{status=~"5.."}[5m])) by (endpoint)
          /
          sum(rate(data_platform_api_requests_total[5m])) by (endpoint)
          * 100 > 5
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High error rate on {{ $labels.endpoint }}"
          description: "Error rate is {{ $value }}% (threshold: 5%)"

      - alert: LowAPIRequestRate
        expr: sum(rate(data_platform_api_requests_total[5m])) < 0.1
        for: 10m
        labels:
          severity: info
          component: api
        annotations:
          summary: "Low API request rate"
          description: "Request rate is {{ $value }} req/s, system may be idle or unreachable"

      # Adapter Alerts
      - alert: AdapterInactive
        expr: data_platform_adapters_inactive_total > 0
        for: 5m
        labels:
          severity: warning
          component: adapters
        annotations:
          summary: "{{ $value }} adapters are inactive"
          description: "Some data adapters are not running properly"

      # System Health Alerts
      - alert: DataPlatformUnhealthy
        expr: data_platform_system_health_status < 1
        for: 3m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Data Platform health check failed"
          description: "System health status is degraded ({{ $value }})"

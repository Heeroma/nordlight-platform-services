version: '3.8'

services:
  # =============================================================================
  # Monitoring Stack
  # =============================================================================
  
  prometheus:
    image: prom/prometheus:latest
    container_name: platform-prometheus
    restart: unless-stopped
    ports:
      - "9092:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts:/etc/prometheus/alerts:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    networks:
      - backend-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  grafana:
    image: grafana/grafana:latest
    container_name: platform-grafana
    restart: unless-stopped
    ports:
      - "3010:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=fasttrader2024
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3010
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_AUTH_DISABLE_LOGIN_FORM=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - backend-network
    depends_on:
      - prometheus

  alertmanager:
    image: prom/alertmanager:latest
    container_name: platform-alertmanager
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager/config.yml:/etc/alertmanager/config.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
    networks:
      - backend-network

  # =============================================================================
  # Logging Stack (Optional - uncomment to enable)
  # =============================================================================
  
  # loki:
  #   image: grafana/loki:latest
  #   container_name: fasttrader-loki
  #   restart: unless-stopped
  #   ports:
  #     - "3100:3100"
  #   volumes:
  #     - ./logging/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
  #     - loki-data:/loki
  #   command: -config.file=/etc/loki/local-config.yaml
  #   networks:
  #     - platform

  # promtail:
  #   image: grafana/promtail:latest
  #   container_name: fasttrader-promtail
  #   restart: unless-stopped
  #   volumes:
  #     - ./logging/promtail/promtail-config.yml:/etc/promtail/config.yml:ro
  #     - /var/log:/var/log:ro
  #     - /var/lib/docker/containers:/var/lib/docker/containers:ro
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   command: -config.file=/etc/promtail/config.yml
  #   networks:
  #     - platform
  #   depends_on:
  #     - loki

  # =============================================================================
  # Tracing Stack (Optional - uncomment to enable)
  # =============================================================================
  
  # jaeger:
  #   image: jaegertracing/all-in-one:latest
  #   container_name: fasttrader-jaeger
  #   restart: unless-stopped
  #   ports:
  #     - "5775:5775/udp"   # zipkin.thrift compact
  #     - "6831:6831/udp"   # jaeger.thrift compact
  #     - "6832:6832/udp"   # jaeger.thrift binary
  #     - "5778:5778"       # serve configs
  #     - "16686:16686"     # UI
  #     - "14268:14268"     # accept jaeger.thrift
  #     - "14250:14250"     # accept model.proto
  #     - "9411:9411"       # zipkin
  #   environment:
  #     - COLLECTOR_ZIPKIN_HOST_PORT=:9411
  #     - COLLECTOR_OTLP_ENABLED=true
  #   networks:
  #     - platform

  # =============================================================================
  # Security Stack (Optional - uncomment to enable)
  # =============================================================================
  
  # vault:
  #   image: vault:latest
  #   container_name: fasttrader-vault
  #   restart: unless-stopped
  #   ports:
  #     - "8200:8200"
  #   environment:
  #     - VAULT_DEV_ROOT_TOKEN_ID=fasttrader-root-token
  #     - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
  #   cap_add:
  #     - IPC_LOCK
  #   volumes:
  #     - ./security/vault/vault-config.json:/vault/config/vault.json:ro
  #     - vault-data:/vault/file
  #   networks:
  #     - platform

  # nginx:
  #   image: nginx:alpine
  #   container_name: fasttrader-gateway
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./security/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./security/nginx/ssl:/etc/nginx/ssl:ro
  #   networks:
  #     - platform
  #   depends_on:
  #     - prometheus
  #     - grafana

  # =============================================================================
  # Shared Infrastructure
  # =============================================================================
  
  # Shared Redis (cache, pub/sub)
  redis:
    image: redis:alpine
    container_name: platform-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Service Discovery (Optional - uncomment to enable)
  # consul:
  #   image: consul:latest
  #   container_name: fasttrader-consul
  #   restart: unless-stopped
  #   ports:
  #     - "8500:8500"   # UI/API
  #     - "8600:8600"   # DNS
  #   command: agent -server -ui -bootstrap-expect=1 -client=0.0.0.0
  #   volumes:
  #     - consul-data:/consul/data
  #   networks:
  #     - platform

  # Message Queue (Optional - uncomment to enable)
  # rabbitmq:
  #   image: rabbitmq:management-alpine
  #   container_name: fasttrader-rabbitmq
  #   restart: unless-stopped
  #   ports:
  #     - "5672:5672"   # AMQP
  #     - "15672:15672" # Management UI
  #   environment:
  #     - RABBITMQ_DEFAULT_USER=admin
  #     - RABBITMQ_DEFAULT_PASS=fasttrader2024
  #   volumes:
  #     - rabbitmq-data:/var/lib/rabbitmq
  #   networks:
  #     - platform

  # System Metrics (Optional - uncomment to enable)
  # node-exporter:
  #   image: prom/node-exporter:latest
  #   container_name: fasttrader-node-exporter
  #   restart: unless-stopped
  #   ports:
  #     - "9100:9100"
  #   networks:
  #     - platform
  #   command:
  #     - '--path.procfs=/host/proc'
  #     - '--path.sysfs=/host/sys'
  #     - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
  #   volumes:
  #     - /proc:/host/proc:ro
  #     - /sys:/host/sys:ro
  #     - /:/rootfs:ro

networks:
  backend-network:
    external: true

volumes:
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  alertmanager-data:
    driver: local
  redis-data:
    driver: local
  # loki-data:
  #   driver: local
  # vault-data:
  #   driver: local
  # consul-data:
  #   driver: local
  # rabbitmq-data:
  #   driver: local
